<!doctype html>
<html lang="en-CA">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Luck Test</title>
  <meta name="description" content="Pick one symbol. Your luck, measured lightly." />

  <style>
    :root {
      --bg: #ffffff;
      --fg: #111111;
      --muted: #666666;
      --border: #e6e6e6;

      /* Translucent overlays so icons remain visible */
      --g10: rgba(10, 122, 47, 0.45);  /* 10/10 */
      --g8:  rgba(10, 122, 47, 0.26);  /* 8/10 */
      --g6:  rgba(10, 122, 47, 0.14);  /* 6/10 */

      --r0:  rgba(176, 0, 32, 0.45);   /* 0/10 */
      --r3:  rgba(176, 0, 32, 0.26);   /* 3/10 */
      --r4:  rgba(176, 0, 32, 0.14);   /* 4/10 */
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    .wrap {
      max-width: 980px;
      margin: 0 auto;
      padding: 12px 12px 22px;
    }

    header {
      display: grid;
      gap: 6px;
      margin-bottom: 10px;
    }

    h1 {
      font-size: clamp(18px, 2.1vw, 26px);
      line-height: 1.15;
      margin: 0;
      letter-spacing: -0.02em;
    }

    .sub {
      font-size: 13px;
      color: var(--muted);
      line-height: 1.4;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      background: #fff;
    }

    /* Grid: 8 columns desktop, 3 columns mobile */
    .grid {
      display: grid;
      gap: 8px;
      margin-top: 8px;
      grid-template-columns: repeat(8, minmax(0, 1fr));
    }

    @media (max-width: 640px) {
      .grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    /* Rectangular tiles */
    .tile {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 14px;
      height: 76px;
      display: grid;
      place-items: center;
      cursor: pointer;
      user-select: none;
      transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
      position: relative;
      overflow: hidden;
      padding: 0;
    }

    @media (max-width: 640px) {
      .tile { height: 74px; }
    }

    .tile:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      border-color: #d8d8d8;
    }

    .tile:active {
      transform: translateY(0px) scale(0.99);
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    .tile[disabled] {
      cursor: not-allowed;
      opacity: 0.92;
      transform: none;
      box-shadow: none;
    }

    .icon {
      width: 30px;
      height: 30px;
      color: var(--fg);
    }

    /* Overlays */
    .overlay {
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 140ms ease;
      pointer-events: none;
    }

    .revealed .overlay {
      opacity: 1;
    }

    .o-g10 { background: var(--g10); }
    .o-g8  { background: var(--g8); }
    .o-g6  { background: var(--g6); }

    .o-r0  { background: var(--r0); }
    .o-r3  { background: var(--r3); }
    .o-r4  { background: var(--r4); }

    /* Selected tile ring */
    .selectedRing::after {
      content: "";
      position: absolute;
      inset: 6px;
      border: 3px solid #111;
      border-radius: 10px;
      pointer-events: none;
    }

    .panel {
      margin-top: 10px;
      border: 1px solid var(--border);
      background: #f7f7f7;
      border-radius: 16px;
      padding: 10px;
      display: grid;
      gap: 8px;
    }

    .result {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
    }

    .resultRow {
      display: grid;
      grid-template-columns: 92px 1fr;
      gap: 10px;
      align-items: center;
    }

    @media (max-width: 640px) {
      .resultRow {
        grid-template-columns: 86px 1fr;
      }
    }

    .previewTile {
      width: 92px;
      height: 72px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: #fff;
      display: grid;
      place-items: center;
      position: relative;
      overflow: hidden;
    }

    @media (max-width: 640px) {
      .previewTile {
        width: 86px;
        height: 70px;
      }
    }

    .previewTile .icon {
      width: 28px;
      height: 28px;
    }

    .previewOverlay {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .result h2 {
      margin: 0;
      font-size: 14px;
    }

    .result p {
      margin: 0;
      color: var(--muted);
      line-height: 1.45;
      font-size: 13px;
      margin-top: 4px;
    }

    .badgeRow {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 8px;
    }

    .badge {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      font-size: 12px;
      color: var(--fg);
    }

    .tiny {
      font-size: 12px;
      color: var(--muted);
    }

    .btnRow {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    button.reset {
      appearance: none;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
    }

    button.reset:hover {
      border-color: #d8d8d8;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Choose an icon below to find out your luck score for the day!</h1>
      <div class="sub">One click per day. No do-overs. Not science.</div>
      <div class="row">
        <div class="pill" id="todayPill">Today:</div>
        <div class="pill" id="lockPill">Status:</div>
      </div>
    </header>

    <div class="grid" id="grid" aria-label="Luck symbol grid"></div>

    <div class="panel">
      <div class="result">
        <div class="resultRow">
          <div class="previewTile" id="previewTile" aria-label="Your selected tile preview">
            <div class="previewOverlay" id="previewOverlay"></div>
            <div id="previewIcon"></div>
          </div>

          <div>
            <h2 id="resultTitle">Pick one.</h2>
            <p id="resultText">Then we see what the universe thinks of you today.</p>
            <div class="badgeRow" id="badgeRow" style="display:none;"></div>
          </div>
        </div>
      </div>

      <div class="btnRow">
        <div class="tiny" id="lockNote"></div>
        <button class="reset" id="resetBtn" type="button" title="Clears today's lock on this device.">
          Dev reset
        </button>
      </div>
    </div>
  </div>

<script>
  // ---------------------------
  // Utilities
  // ---------------------------
  function formatDateLocal(d) {
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function hashString(str) {
    let h = 2166136261 >>> 0;
    for (let i = 0; i < str.length; i++) {
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function mulberry32(seed) {
    return function() {
      let t = seed += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  function getOrCreateUID() {
    const key = "luck_uid_v3";
    let uid = localStorage.getItem(key);
    if (!uid) {
      uid = (crypto && crypto.randomUUID)
        ? crypto.randomUUID()
        : String(Date.now()) + "_" + Math.random().toString(16).slice(2);
      localStorage.setItem(key, uid);
    }
    return uid;
  }

  // ---------------------------
  // Config: 8x3 (24 tiles)
  // ---------------------------
  const COLS = 8;
  const ROWS = 3;
  const CELL_COUNT = COLS * ROWS;

  function rc(idx) { return { r: Math.floor(idx / COLS), c: idx % COLS }; }
  function idxOf(r, c) { return r * COLS + c; }
  function inBounds(r, c) { return r >= 0 && r < ROWS && c >= 0 && c < COLS; }

  function manhattan(a, b) {
    const A = rc(a), B = rc(b);
    return Math.abs(A.r - B.r) + Math.abs(A.c - B.c);
  }

  function orthogonalNeighbors(centerIdx) {
    const C = rc(centerIdx);
    const coords = [[C.r - 1, C.c], [C.r + 1, C.c], [C.r, C.c - 1], [C.r, C.c + 1]];
    return coords.filter(([r,c]) => inBounds(r,c)).map(([r,c]) => idxOf(r,c));
  }

  function diagonalNeighbors(centerIdx) {
    const C = rc(centerIdx);
    const coords = [[C.r - 1, C.c - 1], [C.r - 1, C.c + 1], [C.r + 1, C.c - 1], [C.r + 1, C.c + 1]];
    return coords.filter(([r,c]) => inBounds(r,c)).map(([r,c]) => idxOf(r,c));
  }

  // ---------------------------
  // Icons: use 24 unique SVGs
  // ---------------------------
  const ICONS = [
    { name: "Clover", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M12 14c-1.2 2.5-3.7 4-6 4 0-2.7 1.8-5 4.2-5.6"/><path d="M12 14c1.2 2.5 3.7 4 6 4 0-2.7-1.8-5-4.2-5.6"/><path d="M12 14c-2.4 0-4.5-1.6-4.5-4 0-1.7 1.3-3 3-3 1.2 0 2.2.7 2.6 1.7.4-1 1.4-1.7 2.6-1.7 1.7 0 3 1.3 3 3 0 2.4-2.1 4-4.7 4"/><path d="M12 14v7"/></svg>` },
    { name: "Horseshoe", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M7 3c-2.2 0-4 1.8-4 4v6c0 5 4 8 9 8s9-3 9-8V7c0-2.2-1.8-4-4-4"/><path d="M7 7h.01M7 11h.01M7 15h.01M17 7h.01M17 11h.01M17 15h.01"/></svg>` },
    { name: "Star", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l2.8 6 6.5.6-4.9 4.2 1.5 6.3L12 16.9 6.1 19.1l1.5-6.3L2.7 8.6l6.5-.6L12 2z"/></svg>` },
    { name: "Coin", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="8" rx="7" ry="3"/><path d="M5 8v8c0 1.7 3.1 3 7 3s7-1.3 7-3V8"/><path d="M5 12c0 1.7 3.1 3 7 3s7-1.3 7-3"/></svg>` },
    { name: "Key", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><circle cx="7.5" cy="14.5" r="3.5"/><path d="M11 14.5h10l-2 2 2 2-2 2"/></svg>` },
    { name: "Dice", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="4" width="16" height="16" rx="3"/><path d="M8 8h.01M12 12h.01M16 16h.01"/></svg>` },
    { name: "Rabbit", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M8 7c-1.3-2.6-.6-4.5.6-5.5M12 7c.3-3.1 2-5 4-5.8"/><path d="M6.5 14.5c0-3.3 2.6-6 5.5-6s5.5 2.7 5.5 6-2.6 6-5.5 6-5.5-2.7-5.5-6z"/><path d="M10 14h.01M14 14h.01"/><path d="M11 17c.6.4 1.4.4 2 0"/></svg>` },
    { name: "Elephant", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M7 15c0-4.4 3.1-8 7-8 4 0 7 2.7 7 7v4h-4v-2H9v2H5v-3"/><path d="M14 7c-1.2 1.5-2 3.5-2 5.5 0 2.2.7 4.1 2 5.5"/><path d="M18 14c0 2-1.2 3.5-3 3.5"/></svg>` },
    { name: "Ladybug", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20c4 0 7-3.6 7-8s-3-8-7-8-7 3.6-7 8 3 8 7 8z"/><path d="M12 4v16"/><path d="M9 7h.01M15 7h.01M8 10h.01M16 10h.01"/></svg>` },
    { name: "Lantern", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M8 4h8"/><path d="M9 4c0 3-2 4-2 7s2 4 5 4 5-1 5-4-2-4-2-7"/><path d="M7 11h10"/><path d="M10 15v5h4v-5"/></svg>` },
    { name: "Crown", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M4 8l4 4 4-6 4 6 4-4v10H4V8z"/><path d="M4 18h16"/></svg>` },
    { name: "Feather", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M20 7c-4 0-8 4-10 6-2.5 2.5-3 6-3 8 2 0 5.5-.5 8-3 2-2 6-6 6-11z"/><path d="M9 13l6 6"/><path d="M11 11l4 4"/></svg>` },
    { name: "Heart", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M12 21s-7-4.4-9.5-9C.5 8 3 5.5 6 6c1.6.3 2.7 1.5 3 2 0 0 1.4-2.7 4-2.7 2.7 0 4.7 2.3 4.5 5.2C17.2 15.8 12 21 12 21z"/></svg>` },
    { name: "Moon", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M21 14.5A8.5 8.5 0 1 1 9.5 3.2 7 7 0 0 0 21 14.5z"/></svg>` },
    { name: "Sun", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v3M12 19v3M2 12h3M19 12h3M4.2 4.2l2.1 2.1M17.7 17.7l2.1 2.1M19.8 4.2l-2.1 2.1M6.3 17.7l-2.1 2.1"/></svg>` },
    { name: "Anchor", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="5" r="2"/><path d="M12 7v11"/><path d="M5 14a7 7 0 0 0 14 0"/><path d="M5 14h3M19 14h-3"/></svg>` },
    { name: "Bell", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8a6 6 0 1 0-12 0c0 7-2 7-2 7h16s-2 0-2-7"/><path d="M10 19a2 2 0 0 0 4 0"/></svg>` },
    { name: "Shield", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2l8 4v7c0 5-3.5 9-8 9s-8-4-8-9V6l8-4z"/><path d="M12 6v10"/></svg>` },
    { name: "Candle", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c1 1 1.2 2.2 0 3.2C10.8 5.2 11 4 12 3z"/><path d="M9 10h6v10H9z"/><path d="M8 20h8"/></svg>` },
    { name: "Compass", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="9"/><path d="M14.5 9.5l-2 5-5 2 2-5 5-2z"/></svg>` },
    { name: "Gem", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M6 3h12l3 6-9 12L3 9l3-6z"/><path d="M3 9h18"/><path d="M9 9l3 12 3-12"/></svg>` },
    { name: "Spiral", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a7 7 0 1 0 7 7c0-2.5-2-4-4.5-4S10 9.3 10 11.2c0 1.5 1.2 2.3 2.6 2.3 1.1 0 2-.7 2-1.7"/></svg>` },
    { name: "Hand", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M7 12V6a1 1 0 0 1 2 0v5"/><path d="M9 11V5a1 1 0 0 1 2 0v6"/><path d="M11 11V6a1 1 0 0 1 2 0v5"/><path d="M13 12V7a1 1 0 0 1 2 0v8c0 3-2 5-5 5H8c-2.2 0-4-1.8-4-4v-3c0-.8.7-1.5 1.5-1.5S7 12 7 12z"/></svg>` },
    { name: "Cup", svg: `<svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M7 4h10v7a5 5 0 0 1-10 0V4z"/><path d="M17 6h2a2 2 0 0 1 0 4h-2"/><path d="M8 20h8"/></svg>` }
  ];

  // ---------------------------
  // DOM
  // ---------------------------
  const gridEl = document.getElementById("grid");
  const todayPill = document.getElementById("todayPill");
  const lockPill = document.getElementById("lockPill");
  const lockNote = document.getElementById("lockNote");
  const resetBtn = document.getElementById("resetBtn");

  const resultTitle = document.getElementById("resultTitle");
  const resultText = document.getElementById("resultText");
  const badgeRow = document.getElementById("badgeRow");

  const previewTile = document.getElementById("previewTile");
  const previewOverlay = document.getElementById("previewOverlay");
  const previewIcon = document.getElementById("previewIcon");

  // ---------------------------
  // Daily lock
  // ---------------------------
  const LS_LAST = "luck_last_v3";
  function loadLast() {
    try { return JSON.parse(localStorage.getItem(LS_LAST) || "null"); }
    catch { return null; }
  }
  function saveLast(obj) {
    localStorage.setItem(LS_LAST, JSON.stringify(obj));
  }

  // ---------------------------
  // Seed per user per day
  // ---------------------------
  const uid = getOrCreateUID();
  const todayKey = formatDateLocal(new Date());
  todayPill.textContent = `Today: ${todayKey}`;

  const rng = mulberry32(hashString(`${todayKey}|${uid}|luckgrid_v3`));

  // ---------------------------
  // Shuffle icon placement, use all 24 once
  // ---------------------------
  const iconOrder = Array.from({ length: CELL_COUNT }, (_, i) => i);
  for (let i = iconOrder.length - 1; i > 0; i--) {
    const j = Math.floor(rng() * (i + 1));
    [iconOrder[i], iconOrder[j]] = [iconOrder[j], iconOrder[i]];
  }

  // ---------------------------
  // Pick lucky and unlucky
  // ---------------------------
  const luckyCell = Math.floor(rng() * CELL_COUNT);

  const distances = Array.from({ length: CELL_COUNT }, (_, i) => ({ i, d: manhattan(i, luckyCell) }));
  const maxD = Math.max(...distances.map(x => x.d));
  const farthest = distances.filter(x => x.d === maxD).map(x => x.i);
  const unluckyCell = farthest[Math.floor(rng() * farthest.length)];

  // ---------------------------
  // Score + overlay maps
  // ---------------------------
  const scoreMap = new Array(CELL_COUNT).fill(5);
  const overlayMap = new Array(CELL_COUNT).fill("");
  const prio = new Array(CELL_COUNT).fill(0);

  function setCell(idx, score, overlayClass, priority) {
    if (priority >= prio[idx]) {
      prio[idx] = priority;
      scoreMap[idx] = score;
      overlayMap[idx] = overlayClass;
    }
  }

  // Unlucky zones first (lower priority)
  setCell(unluckyCell, 0, "o-r0", 2);
  orthogonalNeighbors(unluckyCell).forEach(i => setCell(i, 3, "o-r3", 1));
  diagonalNeighbors(unluckyCell).forEach(i => setCell(i, 4, "o-r4", 1));

  // Lucky zones override (higher priority)
  setCell(luckyCell, 10, "o-g10", 4);
  orthogonalNeighbors(luckyCell).forEach(i => setCell(i, 8, "o-g8", 3));
  diagonalNeighbors(luckyCell).forEach(i => setCell(i, 6, "o-g6", 3));

  // ---------------------------
  // Copy
  // ---------------------------
  function labelForScore(score) {
    if (score === 10) return "SUPER LUCKY DAY";
    if (score === 8) return "VERY LUCKY DAY";
    if (score === 6) return "SLIGHTLY LUCKY";
    if (score === 5) return "MEH";
    if (score === 4) return "A BIT OFF";
    if (score === 3) return "UNLUCKY-ISH";
    if (score === 0) return "BAD LUCK DAY";
    return "MEH";
  }

  function messageForScore(score) {
    if (score === 10) return "Perfect hit. If youâ€™ve been waiting for a sign, this is it.";
    if (score === 8) return "Very lucky. Things may line up without you asking.";
    if (score === 6) return "Slightly lucky. Not magic, but the day might be a little smoother.";
    if (score === 5) return "Meh. A standard day in the chaos factory.";
    if (score === 4) return "A bit off. Not cursed. Just mildly resisted.";
    if (score === 3) return "Unlucky-ish. Not terrible, but I would not expect the universe to cooperate.";
    if (score === 0) return "Bad luck day. Keep liquids away from electronics. Maybe skip the lotto.";
    return "Meh.";
  }

  function isLockedToday() {
    const last = loadLast();
    return last && last.date === todayKey;
  }

  function setLockedUI(locked) {
    lockPill.textContent = locked ? "Status: locked for today" : "Status: one pick available";
    lockNote.textContent = locked ? "Come back tomorrow." : "Pick one icon. That is your only pick today.";
    const tiles = gridEl.querySelectorAll(".tile");
    tiles.forEach(t => {
      if (locked) t.setAttribute("disabled", "true");
      else t.removeAttribute("disabled");
    });
  }

  // ---------------------------
  // Preview tile
  // ---------------------------
  function applyPreview(iconSvg, overlayClass) {
    previewIcon.innerHTML = iconSvg;
    previewOverlay.className = `previewOverlay ${overlayClass || ""}`;
    previewTile.classList.add("selectedRing");
  }

  function clearPreview() {
    previewIcon.innerHTML = "";
    previewOverlay.className = "previewOverlay";
    previewTile.classList.remove("selectedRing");
  }

  // ---------------------------
  // Reveal all tiles
  // ---------------------------
  function revealAllTiles(chosenCell) {
    const tiles = gridEl.querySelectorAll(".tile");
    tiles.forEach((tile, i) => {
      tile.classList.add("revealed");
      const overlay = tile.querySelector(".overlay");
      overlay.className = `overlay ${overlayMap[i] || ""}`;

      tile.classList.remove("selectedRing");
      if (i === chosenCell) tile.classList.add("selectedRing");
    });
  }

  // ---------------------------
  // Render grid
  // ---------------------------
  function renderGrid() {
    gridEl.innerHTML = "";
    for (let cell = 0; cell < CELL_COUNT; cell++) {
      const iconIndex = iconOrder[cell];
      const icon = ICONS[iconIndex];

      const tile = document.createElement("button");
      tile.type = "button";
      tile.className = "tile";
      tile.setAttribute("aria-label", `Pick ${icon.name}`);

      tile.innerHTML = `${icon.svg}<div class="overlay"></div>`;

      tile.addEventListener("click", () => {
        if (isLockedToday()) return;

        const score = scoreMap[cell];
        const label = labelForScore(score);

        resultTitle.textContent = `${score}/10: ${label}`;
        resultText.textContent = messageForScore(score);

        badgeRow.style.display = "flex";
        badgeRow.innerHTML = `
          <span class="badge">You picked: <strong>${icon.name}</strong></span>
          <span class="badge">Luck score: <strong>${score}/10</strong></span>
        `;

        revealAllTiles(cell);
        applyPreview(icon.svg, overlayMap[cell]);

        saveLast({
          date: todayKey,
          chosenCell: cell,
          chosenIcon: icon.name,
          score: score,
          overlayClass: overlayMap[cell],
          iconSvg: icon.svg
        });

        setLockedUI(true);
      });

      gridEl.appendChild(tile);
    }
  }

  // ---------------------------
  // Restore if already played
  // ---------------------------
  function restoreIfPlayed() {
    const last = loadLast();
    if (last && last.date === todayKey) {
      resultTitle.textContent = `${last.score}/10: ${labelForScore(last.score)}`;
      resultText.textContent = messageForScore(last.score);

      badgeRow.style.display = "flex";
      badgeRow.innerHTML = `
        <span class="badge">You picked: <strong>${last.chosenIcon}</strong></span>
        <span class="badge">Luck score: <strong>${last.score}/10</strong></span>
      `;

      revealAllTiles(last.chosenCell);
      applyPreview(last.iconSvg, last.overlayClass);
      setLockedUI(true);
      return;
    }

    clearPreview();
    setLockedUI(false);
  }

  // ---------------------------
  // Dev reset
  // ---------------------------
  resetBtn.addEventListener("click", () => {
    localStorage.removeItem(LS_LAST);

    resultTitle.textContent = "Pick one.";
    resultText.textContent = "Then we see what the universe thinks of you today.";
    badgeRow.style.display = "none";

    clearPreview();

    // Remove reveal state and rings
    gridEl.querySelectorAll(".tile").forEach(tile => tile.classList.remove("revealed", "selectedRing"));
    gridEl.querySelectorAll(".overlay").forEach(o => o.className = "overlay");

    setLockedUI(false);
  });

  // Init
  renderGrid();
  restoreIfPlayed();
</script>
</body>
</html>
